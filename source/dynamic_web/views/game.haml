%html
  %head
    :css
      #message-container{
        height: 400px;
        max-width: 500px;
        margin: 15px 0;
        padding: 10px 10px;
        border: solid 5px green;
        overflow: auto;
        background-color: #F0F0F0;
        box-shadow: 5px 5px 5px gray;
        border-radius: 20px 40px;
      }
      .message-item{
        margin: 0 0;
      }
    %script{:src => "http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"}
    :javascript
      $(document).ready(function(){
        function debug(str){ $("#debug").append("<p>"+str+"</p>"); };
        function message(str){ $("#message-container").append("<p class=\"message-item\">"+str+"</p>"); };
        function handle(data){
          var user_sigature=data[0];
          switch(data[1]){
          case 1: message(user_sigature + "登录了。");break;
          case 2: message(user_sigature + "下线了。");break;
          case 3: message(user_sigature + "说：" + data[2]);break;
          case 4: break;
          default: debug(user_sigature + ": unknow command" + data);break;
          }
        };
        ;
        ws = new WebSocket("#{ws_url}");
        ws.onmessage = function(evt){
          handle(JSON.parse(evt.data));
        };
        ws.onopen=function(){
          //debug("connected...");
          //ws.send("hello server");
          $("input").show().focus();
          $("input").keypress(function(e){
            if(e.which==13){
              ws.send(JSON.stringify([3, this.value]));
              this.value = '';
            }
          });
        };
        ws.onclose=function(){ debug("socket closed"); };
        
      });
  %body
    #message-container
    %input{:hidden => true}
    #debug


